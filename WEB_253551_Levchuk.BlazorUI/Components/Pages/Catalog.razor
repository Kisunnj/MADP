@page "/catalog"
@using WEB_253551_Levchuk.BlazorUI.Models
@using WEB_253551_Levchuk.BlazorUI.Services
@using WEB_253551_Levchuk.BlazorUI.Components
@inject IDataService DataService

<PageTitle>Каталог</PageTitle>

<h1>Каталог блюд</h1>

<CategorySelector Categories="@categories" SelectedDish="@selectedCategory" SelectedDishChanged="@OnCategorySelected" />

@if (isLoading)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Загрузка...</span>
        </div>
    </div>
}
else if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
else
{
    <ProductList Dishes="@dishes" />
    
    @if (totalPages > 1)
    {
        <Pager CurrentPage="@currentPage" TotalPages="@totalPages" CurrentPageChanged="@OnPageChanged" />
    }
}

<div class="mt-3">
    <button class="btn btn-primary" @onclick="HandleClick">Подробно</button>
</div>

@code {
    private List<Category>? categories;
    private List<Dish>? dishes;
    private string? selectedCategory;
    private int currentPage = 1;
    private int totalPages = 1;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadDishes();
    }

    private async Task LoadCategories()
    {
        var response = await DataService.GetCategoryListAsync();
        if (response.SuccessFull && response.Data != null)
        {
            categories = response.Data.Items;
        }
    }

    private async Task LoadDishes()
    {
        isLoading = true;
        errorMessage = null;

        var response = await DataService.GetProductListAsync(selectedCategory, currentPage);
        
        if (response.SuccessFull && response.Data != null)
        {
            dishes = response.Data.Items;
            totalPages = response.Data.TotalPages;
        }
        else
        {
            errorMessage = response.ErrorMessage ?? "Не удалось загрузить блюда";
        }

        isLoading = false;
    }

    private async Task OnCategorySelected(string? category)
    {
        selectedCategory = category;
        currentPage = 1;
        await LoadDishes();
        StateHasChanged();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadDishes();
        StateHasChanged();
    }

    private void HandleClick()
    {
        if (dishes != null && dishes.Any())
        {
            var firstDish = dishes.First();
            Console.WriteLine($"Selected dish: {firstDish.Name}");
        }
    }
}

