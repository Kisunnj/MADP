@page "/game"
@using Microsoft.AspNetCore.SignalR.Client
@using WEB_253551_Levchuk.BlazorUI.Models.Game
@inject NavigationManager Navigation
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Игра - Чак-а-лак</PageTitle>

<h1>Чак-а-лак (Chuck-a-Luck)</h1>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Правила игры</h5>
                <ul>
                    <li>Сделайте ставку на число от 1 до 6</li>
                    <li>Бросьте 3 кости</li>
                    <li>1 совпадение: выигрыш x2</li>
                    <li>2 совпадения: выигрыш x3</li>
                    <li>3 совпадения: выигрыш x10</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Статус игры</h5>
                <p><strong>Комната:</strong> @roomId</p>
                <p><strong>Игроков:</strong> @playerCount / 2</p>
                <p><strong>Баланс:</strong> @balance</p>
            </div>
        </div>
    </div>
</div>

@if (!isConnected)
{
    <div class="card mb-4">
        <div class="card-body">
            <h5>Присоединиться к игре</h5>
            <div class="mb-3">
                <label class="form-label">Имя игрока:</label>
                <input @bind="playerName" class="form-control" placeholder="Введите имя" />
            </div>
            <div class="mb-3">
                <label class="form-label">ID комнаты:</label>
                <input @bind="roomId" class="form-control" placeholder="Введите ID комнаты" />
            </div>
            <button class="btn btn-primary" @onclick="JoinRoom" disabled="@(!CanJoin)">
                Присоединиться
            </button>
        </div>
    </div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <h5>Сделать ставку</h5>
            <div class="row">
                @for (int i = 1; i <= 6; i++)
                {
                    var number = i;
                    <div class="col-2">
                        <button class="btn btn-outline-primary w-100 mb-2" 
                                @onclick="() => SelectNumber(number)"
                                disabled="@(gameState != GameState.Waiting)">
                            @number
                        </button>
                    </div>
                }
            </div>
            <div class="mt-3">
                <label class="form-label">Размер ставки:</label>
                <input type="number" @bind="betAmount" class="form-control" min="10" max="@balance" step="10" />
            </div>
            <button class="btn btn-success mt-3" 
                    @onclick="PlaceBet" 
                    disabled="@(selectedNumber == 0 || betAmount == 0 || gameState != GameState.Waiting)">
                Сделать ставку
            </button>
        </div>
    </div>

    @if (diceResults != null && diceResults.Length == 3)
    {
        <div class="card mb-4">
            <div class="card-body">
                <h5>Результат броска:</h5>
                <div class="d-flex justify-content-center">
                    @foreach (var dice in diceResults)
                    {
                        <div class="dice-result">@dice</div>
                    }
                </div>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(gameMessage))
    {
        <div class="alert alert-info">
            @gameMessage
        </div>
    }
}

<div class="card">
    <div class="card-body">
        <h5>Лог игры</h5>
        <div class="game-log" style="max-height: 200px; overflow-y: auto;">
            @foreach (var message in messages)
            {
                <div>@message</div>
            }
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private List<string> messages = new();
    private string? playerName;
    private string? roomId = "room1";
    private bool isConnected = false;
    private int playerCount = 0;
    private int balance = 1000;
    private int selectedNumber = 0;
    private int betAmount = 50;
    private int[]? diceResults;
    private GameState gameState = GameState.Waiting;
    private string? gameMessage;

    private bool CanJoin => !string.IsNullOrWhiteSpace(playerName) && !string.IsNullOrWhiteSpace(roomId);

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .Build();

        hubConnection.On<string, int>("PlayerJoined", (name, count) =>
        {
            messages.Add($"Игрок {name} присоединился к игре");
            playerCount = count;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("PlayerLeft", (name) =>
        {
            messages.Add($"Игрок {name} покинул игру");
            playerCount--;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string, int, int>("BetPlaced", (name, number, amount) =>
        {
            messages.Add($"{name} поставил {amount} на число {number}");
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int[]>("DiceRolled", (results) =>
        {
            diceResults = results;
            messages.Add($"Результат броска: {string.Join(", ", results)}");
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<int, int, int>("GameResult", (matches, winAmount, newBalance) =>
        {
            balance = newBalance;
            if (matches == 0)
            {
                gameMessage = "Нет совпадений. Вы проиграли.";
            }
            else
            {
                gameMessage = $"Совпадений: {matches}. Выигрыш: {winAmount}!";
            }
            messages.Add(gameMessage);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<GameRoom>("UpdateRoom", (room) =>
        {
            gameState = room.State;
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("Error", (error) =>
        {
            messages.Add($"Ошибка: {error}");
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task JoinRoom()
    {
        if (hubConnection is not null && CanJoin)
        {
            await hubConnection.SendAsync("JoinRoom", roomId, playerName);
            isConnected = true;
        }
    }

    private void SelectNumber(int number)
    {
        selectedNumber = number;
        gameMessage = $"Выбрано число: {number}";
    }

    private async Task PlaceBet()
    {
        if (hubConnection is not null && selectedNumber > 0 && betAmount > 0)
        {
            await hubConnection.SendAsync("PlaceBet", selectedNumber, betAmount);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}

<style>
    .dice-result {
        width: 80px;
        height: 80px;
        border: 2px solid #333;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        font-weight: bold;
        margin: 10px;
        background-color: #fff;
    }

    .game-log {
        font-family: monospace;
        font-size: 14px;
    }
</style>

